# 1 Libraries

```{r}
library(fistools)
library(camtraptor)
library(tidyverse)
```

# 2 Input

```{r get data from drive}
download_gdrive_if_missing(gfileID = "1ZPqoyayFzD9WH2UQ4aAzPwH3Q9b28zT5",
                           destfile = "./Zonien/Input/zonien.zip", 
                           email = Sys.getenv("email"),
                           update_always = TRUE)
# You may need to input your email address: be sure that it is the email adress with which you have access to the AGOUTI export Drive -- ask Sander if you're not sure.
# Note to student: you do not have the necessary rights to *make changes* in the Drive where this file is kept -- but you should have enough rights to access the file
# But no worries, if you need the latest export: ask anyone that works on the project to make a new export (make take a while) and update it in this Drive.
# It is essential that the new export be named Zonien.zip so that it replaces the old files, but keeps the same gfileID
```

```{r unzip and read data}
# Unzip data
unzip("./Zonien/Input/zonien.zip", 
      exdir = "./Zonien/Input/Files")

# Read data
zs <- camtraptor::read_camtrap_dp(file = "./Zonien/Input/Files")
```

```{r unlink files}
unlink("./Zonien/Input/Files",
       recursive = TRUE)
file.remove("./Zonien/Input/zonien.zip")
```

# 3 Get relevant deployments

```{r}
zs$data$deployments <-  zs$data$deployments %>%
  mutate(year = year(start),
         month = month(start))
```

## 3.1 Older years (FYI only)

We don't have any yet, you're the first one to do this for Zonien!

## 3.2 Current year

```{r for 2025 field season}
dep <- zs$data$deployments %>%
  filter(year == 2025,
         month %in% 10:11)
depID <- c(dep$deploymentID)
```

## 3.3 Filter for deployments with actual calibration within timeframe

```{r get deps with calibration}
deps_with_cal <- zs$data$observations %>%
  filter(deploymentID %in% depID) %>%
  filter(cameraSetup == "calibration")
deps_with_cal <- unique(deps_with_cal$deploymentID)

depID <- depID[depID %in% deps_with_cal]
```

# 4 Get relevant sequences

## 4.1 Species filter

```{r}
species <- c("Capreolus capreolus", "Sus scrofa", "Dama dama", "Vulpes vulpes")
# Dama dama is probably not necessary (should only be 1 animal in the whole forest), but you never know
```

## 4.2 Combine all filters

```{r}
obs <- zs$data$observations %>%
  filter(deploymentID %in% depID) %>%
  filter(scientificName %in% species)

seqID <- c(unique(obs$sequenceID)) # All seq to do
```

# 5 Remove already-done sequences

```{r}
seq_done <- read_csv("./Zonien/Input/tracking_seq_done.csv")
seq_done <- c(seq_done$sequenceID)
```

```{r}
seqID <- seqID[!seqID %in% seq_done]
```

# 6 Open sequences in Agouti

```{r}
for (i in 1:length(seqID)) {
  # Open URL
  browseURL(url = paste0("https://www.agouti.eu/project/3b9f65bb-d7b9-49dd-8dd1-62e22a11e478/observations/edit-sequence/",
                         seqID[i]))
  # append seqID to done file to skip next time
  write.table(data.frame(sequenceID = seqID[i]),
              "./Zonien/Input/tracking_seq_done.csv",
              append = TRUE,
              row.names = FALSE,
              col.names = FALSE)
  # Naar de volgende reeks of niet?
  if (!askYesNo("Do you wanna go to the next sequence?")) {
    break
  }
}
```

