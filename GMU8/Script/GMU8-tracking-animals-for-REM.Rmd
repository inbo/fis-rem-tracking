# 1 Libraries

```{r libraries}
library(fistools)
library(camtraptor)
library(tidyverse)
```

# 2 Input

```{r get data from drive}
zip_dir <- "./GMU8/Input"
files_dir <- "./GMU8/Input/FilesGMU8"
# unzip_last_modified_zip(folder_id = "17kmOtVEavkE_f9pO5z5GPQCBvM4QnFGm",
#                         exdir = files_dir)
# gmu8 <- camtraptor::read_camtrap_dp(file = file.path(files_dir, "datapackage.json"),
#                                     media = TRUE)

download_gdrive_if_missing(gfileID = "1RXl7gY65Kk-_KjSTYSgkilCt9yJ49N9-",
                           destfile = file.path(zip_dir, "gmu8.zip"),
                           update_always = TRUE,
                           email = Sys.getenv("email"))
unzip("./GMU8/Input/gmu8.zip",
      exdir = file.path(files_dir))
```

```{r}
gmu8 <- camtraptor::read_camtrap_dp("./GMU8/Input/FilesGMU8",
                                    media = TRUE)
```

```{r unlink files}
unlink("./GMU8/Input/FilesGMU8",
       recursive = TRUE)
remove(gmu8.zip)
```

# 3 Get relevant deployments

```{r prepare data for filtering}
gmu8$data$deployments <- gmu8$data$deployments %>% 
  mutate(var = locationName) %>%
  separate(var, 
           into = c("year_loc",
                    "serie",
                    "gridcell"),
           "_") %>%
  mutate(year = year(start))
```

## 3.1 Older years (FYI only)

```{r for 2022 field season, eval = FALSE}
# dep <- gmu8$data$deployments %>%
#   filter(year == 2022,
#          serie %in% 7:9)
```

```{r for 2023 field season, eval = FALSE}
# dep <- gmu8$data$deployments %>%
#   filter(year == 2023,
#          serie %in% 9:11)
```

```{r for 2024 field season, eval = FALSE}
# dep <- gmu8$data$deployments %>%
#   filter(year == 2024,
#          serie %in% 9:11)
```

## 3.2 Current year general filtering

```{r for 2025 field season}
dep <- gmu8$data$deployments %>%
  filter(year == 2025,
         serie %in% 9:10) # Check with Jim for 11
depID <- c(dep$deploymentID)
```

## 3.3 Filter for deployments with actual calibration within timeframe

```{r get deps with calibration}
deps_with_cal <- gmu8$data$observations %>%
  filter(deploymentID %in% depID) %>%
  filter(cameraSetup == "calibration")
deps_with_cal <- unique(deps_with_cal$deploymentID)

depID <- depID[depID %in% deps_with_cal]
```

# 4 Get relevant sequences

## 4.1 Species filter

```{r species list for this project}
#species <- c("Capreolus capreolus", "Sus scrofa", "Vulpes vulpes", "Dama dama")
species <- c("Capreolus capreolus")

```

## 4.2. Combine all filters

```{r get relevant seqID by combining all filters}
obs <- gmu8$data$observations %>%
  filter(deploymentID %in% depID) %>% # Right month and year and only if calibrated in the field
  filter(scientificName %in% species) # Self-explanatory

seqID <- c(unique(obs$sequenceID)) # All seq that have to be done at some point in time
```

# 5 Remove already-done sequences

```{r read seq_done}
seq_done <- read_csv("./GMU8/Input/tracking_seq_done.csv")
seq_done <- c(seq_done$sequenceID)
```

```{r filter out seq_done}
seqID <- seqID[!seqID %in% seq_done]
```

# 6 Open sequences in Agouti

Before you run this, read this:

This for-loop will open the relevant sequences one-by-one in Agouti. To ensure you don't get flooded by all the sequences at once, I built in a break by means of a popu-up. This is what the different options mean:

* YES/JA: I have tracked this sequence and I want to go to the next sequence
* NO/NEE: I have tracked this sequence but I need a break (for whatever reason), so do not open the next sequence in Agouti
* CANCEL/ANNULEREN: I have not annotated this sequence (for whaterver reason) and do not want to see the next sequence. *WARNING Check that this last sequenceID is not added to tracking_seq_done.csv. If yes, delete this (and ONLY this) seqID manually from tracking_seq_done.csv*

```{r open leftover seq in Agouti}
for (i in 1:length(seqID)) {
  # Open URL
  browseURL(url = paste0("https://www.agouti.eu/project/91e1e104-a296-461e-af79-eeb6cb3e6c7f/observations/edit-sequence/",
                         seqID[i]))
  # append seqID to done file to skip next time
  write.table(data.frame(sequenceID = seqID[i]),
              "./GMU8/Input/tracking_seq_done.csv",  # Make sure these are in your WD
              append = TRUE,
              row.names = FALSE,
              col.names = FALSE)
  # Next sequence?
  if (!askYesNo("Do you wanna go to the next sequence?")) {
    break
  }
}
```

